#!/bin/bash

if [ $# -ne 6 ]; then
    echo "create-bundle: argument error" >&2
    echo "usage: create-bundle [yes|no] <uid> <home> <server> <addr> <port>" >&2
    exit 1
fi

crcrt=$1
shift

uid=$1
home=$2
server=$3
addr=$4
port=$5

ssl=/etc/univention/ssl

# create or renew certificate for user
if /usr/sbin/univention-certificate check -name "${uid}.openvpn"; then
  if [ "$crtcr" = yes ]; then
    defdays=$(ucr get ssl/default/days)
    if [ -z "$defdays" ]; then
        defdays=1825
    fi
    univention-certificate renew -days ${defdays} -name "${uid}.openvpn"
  fi
else
    univention-certificate new -name "${uid}.openvpn"
fi

# prepare a matching client config
cat > "${ssl}/${uid}.openvpn/${server}.ovpn" <<-ENDOFCLIENTCONFIG
	# client config for server ${server}

	client
	dev tun0
	proto udp
	remote ${addr} ${port}
	tls-remote ${server}
	resolv-retry infinite
	nobind
	persist-key
	persist-tun
	ca CAcert.pem
	cert cert.pem
	key private.key
	comp-lzo
	verb 3
	auth-user-pass

	script-security 2
	up /etc/openvpn/update-resolv-conf 
	down /etc/openvpn/update-resolv-conf

ENDOFCLIENTCONFIG

# prepare a matching client config (windows)
cat > "${ssl}/${uid}.openvpn/win-${server}.ovpn" <<-ENDOFWINCLIENTCONFIG
	# windows client config for server ${server}

	client
	dev tun
	proto udp
	remote ${addr} ${port}
	tls-remote ${server}
	resolv-retry infinite
	nobind
	persist-key
	persist-tun
	ca CAcert.pem
	cert cert.pem
	key private.key
	comp-lzo
	verb 3
	auth-user-pass

ENDOFWINCLIENTCONFIG

eval "$(ucr shell ldap/base)"

# zip all required files into home or apache directory of user
if [ -d "$home" ]; then
    bundle="${home}/openvpn-${server}-${uid}.zip"
else
    mkdir -p "/var/www/${uid}/"
    cat > "/var/www/${uid}/.htaccess" <<-ENDOFHTACCESS
AuthBasicProvider ldap
AuthType Basic
AuthName "secret"
AuthzLDAPAuthoritative off
AuthLDAPURL "ldap://localhost:7389/$ldap_base?uid"
AuthLDAPBindDN "uid=ldapper,cn=users,$ldap_base"
AuthLDAPBindPassword "ldapperssecret"
Require ldap-user ${uid}

ENDOFHTACCESS

    if [ ! -f /etc/apache2/mods-enabled/ldap.load ] || [ ! -f /etc/apache2/mods-enabled/authnz_ldap.load ]; then
        a2enmod ldap
        a2enmod authnz_ldap
        /etc/init.d/apache2 restart
    fi

    bundle="/var/www/${uid}/openvpn-${server}-${uid}.zip"
fi

umask 077
zip -j "$bundle" \
    "${ssl}/ucsCA/CAcert.pem" \
    "${ssl}/${uid}.openvpn/cert.pem" \
    "${ssl}/${uid}.openvpn/private.key" \
    "${ssl}/${uid}.openvpn/${server}.ovpn" \
    "${ssl}/${uid}.openvpn/win-${server}.ovpn"
chown "$uid" "$bundle"

exit 0
